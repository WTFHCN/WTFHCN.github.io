<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="树套树," />





  <link rel="alternate" href="/atom.xml" title="NaCNer" type="application/atom+xml" />






<meta name="description" content="给定$n$个空集合，有$2$操作。  在$[l,r]$集合中加入$x$,$|x|\leq n$ 查询$[l,r]$集合中所有元素的第$k$大,$k\leq 2^{63}$  注意是第$k$大">
<meta property="og:type" content="article">
<meta property="og:title" content="ZJOI 第K大数查询">
<meta property="og:url" content="http://yoursite.com/2020/02/17/ZJOI%E7%AC%ACK%E5%A4%A7%E6%9F%A5%E8%AF%A2/index.html">
<meta property="og:site_name" content="NaCNer">
<meta property="og:description" content="给定$n$个空集合，有$2$操作。  在$[l,r]$集合中加入$x$,$|x|\leq n$ 查询$[l,r]$集合中所有元素的第$k$大,$k\leq 2^{63}$  注意是第$k$大">
<meta property="article:published_time" content="2020-02-17T04:14:13.000Z">
<meta property="article:modified_time" content="2020-03-17T01:56:10.253Z">
<meta property="article:author" content="HCN">
<meta property="article:tag" content="树套树">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/02/17/ZJOI第K大查询/"/>





  <title>ZJOI 第K大数查询 | NaCNer</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">NaCNer</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/17/ZJOI%E7%AC%ACK%E5%A4%A7%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HCN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NaCNer">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ZJOI 第K大数查询</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-17T12:14:13+08:00">
                2020-02-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>给定$n$个空集合，有$2$操作。</p>
<ul>
<li>在$[l,r]$集合中加入$x$,$|x|\leq n$</li>
<li><p>查询$[l,r]$集合中所有元素的第$k$大,$k\leq 2^{63}$</p>
</li>
<li><p>注意是第$k$大</p>
</li>
</ul>
<a id="more"></a>
<h3 id="权值线段树套区间线段树"><a href="#权值线段树套区间线段树" class="headerlink" title="权值线段树套区间线段树"></a>权值线段树套区间线段树</h3><p>考虑在权值线段树二分寻找答案时，可以在动态在每一个点建立区间选段树$sum=query(tree[rs],ql,qr)$,若$k&lt;=sum$,往右跳，反之往左挑。（$n\log^2 n$常数，内存过大，开$O2$才过得去）。</p>
<hr>
<h3 id="树状数组套主席树"><a href="#树状数组套主席树" class="headerlink" title="树状数组套主席树"></a>树状数组套主席树</h3><p>考虑之前求第$k$大时主席树的建立。通过对比$tr[ql],tr[qr]$,这两个主席树从而确定答案，而这次要通过$tr[ql,qr]$,<strong>这些</strong>主席树确定答案。考虑吧用树状数组差分维护区间修改，区间查询。</p>
<script type="math/tex; mode=display">
    d[i]=a[i]-a[i-1],a[i]=\sum_{i=1}^n d[i]\\
    \sum_{i=1}^n a[i]=(n+1)*\sum d[i]-\sum i*d[i]</script><hr>
<h3 id="整体二分"><a href="#整体二分" class="headerlink" title="整体二分"></a>整体二分</h3><p>整体二分模版题，把树状数组的修改查询，改成线段树的，或则差分树状数组。</p>
<hr>
<h2 id=""><a href="#" class="headerlink" title=""></a><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ls tr[pos].l</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rs tr[pos].r</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">5e4</span> + <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xi</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> l, r;</span><br><span class="line">&#125; tree[N * <span class="number">400</span>];</span><br><span class="line">ll sum[N * <span class="number">400</span>];</span><br><span class="line"><span class="keyword">int</span> tt[N][<span class="number">4</span>], te[N], num, li[N], tcnt, ti[N][<span class="number">2</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lowbit</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (-x) &amp; x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> &amp;pos, <span class="keyword">int</span> x, <span class="keyword">int</span> w, <span class="keyword">int</span> l = <span class="number">1</span>, <span class="keyword">int</span> r = num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!pos)</span><br><span class="line">        pos = ++tcnt;</span><br><span class="line">    sum[pos] += w;</span><br><span class="line">    <span class="keyword">if</span> (l == r)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">        add(tree[pos].l, x, w, l, mid);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        add(tree[pos].r, x, w, mid + <span class="number">1</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(ll k, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> l = <span class="number">1</span>, <span class="keyword">int</span> r = num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (l == r)</span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line">    ll R = <span class="number">0</span>, L = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//cout &lt;&lt; te[0] &lt;&lt; " " &lt;&lt; te[1] &lt;&lt; " " &lt;&lt; te[2] &lt;&lt; " " &lt;&lt; te[3] &lt;&lt; endl;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">0</span>]; i++)</span><br><span class="line">        R -= <span class="number">1l</span>l * (x + <span class="number">1</span>) * sum[tree[tt[i][<span class="number">0</span>]].r]; <span class="comment">//ti[0]维护差分(x+1)*(d[1]+d[2]...d[x])</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">1</span>]; i++)</span><br><span class="line">        R += <span class="number">1l</span>l * (y + <span class="number">1</span>) * sum[tree[tt[i][<span class="number">1</span>]].r];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">2</span>]; i++) <span class="comment">// ti[1维护(1*d[1]-2*d[2]...x*d[x])</span></span><br><span class="line">        L -= <span class="number">1l</span>l * sum[tree[tt[i][<span class="number">2</span>]].r];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">3</span>]; i++)</span><br><span class="line">        L += <span class="number">1l</span>l * sum[tree[tt[i][<span class="number">3</span>]].r];</span><br><span class="line">    ll res = R - L;</span><br><span class="line">    <span class="comment">//cout &lt;&lt; x &lt;&lt; " " &lt;&lt; y &lt;&lt; " " &lt;&lt; res &lt;&lt; endl;</span></span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (k &lt;= res)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">0</span>]; i++)</span><br><span class="line">            tt[i][<span class="number">0</span>] = tree[tt[i][<span class="number">0</span>]].r;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">1</span>]; i++)</span><br><span class="line">            tt[i][<span class="number">1</span>] = tree[tt[i][<span class="number">1</span>]].r;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">2</span>]; i++) <span class="comment">// ti[1维护(1*d[1]-2*d[2]...x*d[x])</span></span><br><span class="line">            tt[i][<span class="number">2</span>] = tree[tt[i][<span class="number">2</span>]].r;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">3</span>]; i++)</span><br><span class="line">            tt[i][<span class="number">3</span>] = tree[tt[i][<span class="number">3</span>]].r;</span><br><span class="line">        <span class="keyword">return</span> query(k, x, y, mid + <span class="number">1</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">0</span>]; i++)</span><br><span class="line">            tt[i][<span class="number">0</span>] = tree[tt[i][<span class="number">0</span>]].l;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">1</span>]; i++)</span><br><span class="line">            tt[i][<span class="number">1</span>] = tree[tt[i][<span class="number">1</span>]].l;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">2</span>]; i++) <span class="comment">// ti[1维护(1*d[1]-2*d[2]...x*d[x])</span></span><br><span class="line">            tt[i][<span class="number">2</span>] = tree[tt[i][<span class="number">2</span>]].l;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= te[<span class="number">3</span>]; i++)</span><br><span class="line">            tt[i][<span class="number">3</span>] = tree[tt[i][<span class="number">3</span>]].l;</span><br><span class="line">        <span class="keyword">return</span> query(k - res, x, y, l, mid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pre_query</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, ll k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        te[i] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    l--;</span><br><span class="line">    <span class="keyword">int</span> x = l, y = r;</span><br><span class="line">    <span class="keyword">while</span> (l)</span><br><span class="line">    &#123;</span><br><span class="line">        tt[++te[<span class="number">0</span>]][<span class="number">0</span>] = ti[l][<span class="number">0</span>];</span><br><span class="line">        tt[++te[<span class="number">2</span>]][<span class="number">2</span>] = ti[l][<span class="number">1</span>];</span><br><span class="line">        l -= lowbit(l);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (r)</span><br><span class="line">    &#123;</span><br><span class="line">        tt[++te[<span class="number">1</span>]][<span class="number">1</span>] = ti[r][<span class="number">0</span>];</span><br><span class="line">        tt[++te[<span class="number">3</span>]][<span class="number">3</span>] = ti[r][<span class="number">1</span>];</span><br><span class="line">        r -= lowbit(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> li[query(k, x, y)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//cout&lt;&lt;x&lt;&lt;endl;</span></span><br><span class="line">    r++;</span><br><span class="line">    <span class="keyword">int</span> rr = r;</span><br><span class="line">    <span class="keyword">int</span> ll = l;</span><br><span class="line">    <span class="keyword">while</span> (r &lt;= n)</span><br><span class="line">    &#123;</span><br><span class="line">        add(ti[r][<span class="number">0</span>], x, <span class="number">-1</span>);</span><br><span class="line">        add(ti[r][<span class="number">1</span>], x, -rr);</span><br><span class="line">        r += lowbit(r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (l &lt;= n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//cout &lt;&lt; l &lt;&lt; endl;</span></span><br><span class="line">        add(ti[l][<span class="number">0</span>], x, <span class="number">1</span>);</span><br><span class="line">        add(ti[l][<span class="number">1</span>], x, ll);</span><br><span class="line">        l += lowbit(l);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//cout &lt;&lt; ti[2][0] &lt;&lt; endl;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> op, l, r;</span><br><span class="line">    ll k;</span><br><span class="line">&#125; q[N];</span><br><span class="line"><span class="keyword">int</span> m;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d%d%d%lld"</span>, &amp;q[i].op, &amp;q[i].l, &amp;q[i].r, &amp;q[i].k);</span><br><span class="line">        <span class="keyword">if</span> (q[i].op == <span class="number">1</span>)</span><br><span class="line">            li[++num] = q[i].k;</span><br><span class="line">    &#125;</span><br><span class="line">    sort(<span class="number">1</span> + li, li + <span class="number">1</span> + num);</span><br><span class="line">    num = unique(<span class="number">1</span> + li, li + <span class="number">1</span> + num) - li - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">        <span class="keyword">if</span> (q[i].op == <span class="number">1</span>)</span><br><span class="line">            q[i].k = lower_bound(<span class="number">1</span> + li, <span class="number">1</span> + li + num, q[i].k) - li;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (q[i].op == <span class="number">1</span>)</span><br><span class="line">            update(q[i].l, q[i].r, q[i].k);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, pre_query(q[i].l, q[i].r, q[i].k));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ls tr[pos].l</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rs tr[pos].r</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">5e4</span> + <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">segtree</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> l, r, lazy;</span><br><span class="line">    ll sum;</span><br><span class="line">&#125; tr[N * <span class="number">32</span> * <span class="number">20</span>];</span><br><span class="line"><span class="keyword">int</span> li[N], tcnt, num, n, ti[N &lt;&lt; <span class="number">2</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(<span class="keyword">int</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    tr[pos].sum = tr[ls].sum + tr[rs].sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> v = tr[pos].lazy, mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!tr[pos].l)</span><br><span class="line">            tr[pos].l = ++tcnt;</span><br><span class="line">        <span class="keyword">if</span> (!tr[pos].r)</span><br><span class="line">            tr[pos].r = ++tcnt;</span><br><span class="line">        tr[ls].sum += v * (mid - l + <span class="number">1</span>);</span><br><span class="line">        tr[rs].sum += v * (r - mid);</span><br><span class="line">        tr[ls].lazy += v;</span><br><span class="line">        tr[rs].lazy += v;</span><br><span class="line">        tr[pos].lazy = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> ql, <span class="keyword">int</span> qr, <span class="keyword">int</span> l = <span class="number">1</span>, <span class="keyword">int</span> r = n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!pos)</span><br><span class="line">        pos = ++tcnt;</span><br><span class="line">    <span class="keyword">if</span> (ql &lt;= l &amp;&amp; r &lt;= qr)</span><br><span class="line">    &#123;</span><br><span class="line">        tr[pos].lazy++;</span><br><span class="line">        tr[pos].sum += (r - l + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> pos;</span><br><span class="line">    &#125;</span><br><span class="line">    pushdown(pos, l, r);</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (ql &lt;= mid)</span><br><span class="line">        tr[pos].l = add(tr[pos].l, ql, qr, l, mid);</span><br><span class="line">    <span class="keyword">if</span> (qr &gt; mid)</span><br><span class="line">        tr[pos].r = add(tr[pos].r, ql, qr, mid + <span class="number">1</span>, r);</span><br><span class="line">    <span class="comment">//tr[pos].sum = tr[ls].sum + tr[rs].sum;</span></span><br><span class="line">    pushup(pos);</span><br><span class="line">    <span class="keyword">return</span> pos;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">ll <span class="title">calc</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> ql, <span class="keyword">int</span> qr, <span class="keyword">int</span> l = <span class="number">1</span>, <span class="keyword">int</span> r = n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!pos)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ql &lt;= l &amp;&amp; r &lt;= qr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tr[pos].sum;</span><br><span class="line">    &#125;</span><br><span class="line">    pushdown(pos, l, r);</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    ll res = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ql &lt;= mid)</span><br><span class="line">        res += calc(tr[pos].l, ql, qr, l, mid);</span><br><span class="line">    <span class="keyword">if</span> (qr &gt; mid)</span><br><span class="line">        res += calc(tr[pos].r, ql, qr, mid + <span class="number">1</span>, r);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> ql, <span class="keyword">int</span> qr, <span class="keyword">int</span> x, <span class="keyword">int</span> pos = <span class="number">1</span>, <span class="keyword">int</span> l = <span class="number">1</span>, <span class="keyword">int</span> r = num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ti[pos] = add(ti[pos], ql, qr);</span><br><span class="line">    <span class="keyword">if</span> (l == r)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">        update(ql, qr, x, pos &lt;&lt; <span class="number">1</span>, l, mid);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        update(ql, qr, x, pos &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> ql, <span class="keyword">int</span> qr, ll k, <span class="keyword">int</span> pos = <span class="number">1</span>, <span class="keyword">int</span> l = <span class="number">1</span>, <span class="keyword">int</span> r = num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (l == r)</span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line">    ll sum = calc(ti[pos &lt;&lt; <span class="number">1</span> | <span class="number">1</span>], ql, qr);</span><br><span class="line">    <span class="comment">// cout &lt;&lt; pos &lt;&lt; " " &lt;&lt; ql &lt;&lt; " " &lt;&lt; qr &lt;&lt; " " &lt;&lt; sum &lt;&lt; "---" &lt;&lt; tr[2].lazy &lt;&lt; endl;</span></span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (k &lt;= sum)</span><br><span class="line">        <span class="keyword">return</span> query(ql, qr, k, pos &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, r);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> query(ql, qr, k - sum, pos &lt;&lt; <span class="number">1</span>, l, mid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> op, l, r;</span><br><span class="line">    ll k;</span><br><span class="line">&#125; q[N];</span><br><span class="line"><span class="keyword">int</span> m;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d%d%d%lld"</span>, &amp;q[i].op, &amp;q[i].l, &amp;q[i].r, &amp;q[i].k);</span><br><span class="line">        <span class="keyword">if</span> (q[i].op == <span class="number">1</span>)</span><br><span class="line">            li[++num] = q[i].k;</span><br><span class="line">    &#125;</span><br><span class="line">    sort(<span class="number">1</span> + li, li + <span class="number">1</span> + num);</span><br><span class="line">    num = unique(<span class="number">1</span> + li, li + <span class="number">1</span> + num) - li - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">        <span class="keyword">if</span> (q[i].op == <span class="number">1</span>)</span><br><span class="line">            q[i].k = lower_bound(<span class="number">1</span> + li, <span class="number">1</span> + li + num, q[i].k) - li;</span><br><span class="line">    <span class="comment">//cout &lt;&lt; num &lt;&lt; endl;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (q[i].op == <span class="number">1</span>)</span><br><span class="line">            update(q[i].l, q[i].r, q[i].k);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, li[query(q[i].l, q[i].r, q[i].k)]); <span class="comment">//这里是第K大不是，第K小。</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ls tr[pos].l</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rs tr[pos].r</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1e5</span> + <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">1e9</span> + <span class="number">7</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> op, l, r, id;</span><br><span class="line">    ll k;</span><br><span class="line">&#125; q[N], ql[N], qr[N];</span><br><span class="line"><span class="keyword">int</span> ans[N];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ll sum;</span><br><span class="line">    ll lazy;</span><br><span class="line">&#125; tree[N &lt;&lt; <span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree[pos].lazy)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> w = tree[pos].lazy;</span><br><span class="line">        tree[pos &lt;&lt; <span class="number">1</span>].lazy += w;</span><br><span class="line">        tree[pos &lt;&lt; <span class="number">1</span> | <span class="number">1</span>].lazy += w;</span><br><span class="line">        tree[pos &lt;&lt; <span class="number">1</span>].sum += <span class="number">1l</span>l * w * (mid - l + <span class="number">1</span>);</span><br><span class="line">        tree[pos &lt;&lt; <span class="number">1</span> | <span class="number">1</span>].sum += <span class="number">1l</span>l * w * (r - mid);</span><br><span class="line">        tree[pos].lazy = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(<span class="keyword">int</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    tree[pos].sum = tree[pos &lt;&lt; <span class="number">1</span>].sum + tree[pos &lt;&lt; <span class="number">1</span> | <span class="number">1</span>].sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> ql, <span class="keyword">int</span> qr, <span class="keyword">int</span> w, <span class="keyword">int</span> pos, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ql &lt;= l &amp;&amp; r &lt;= qr)</span><br><span class="line">    &#123;</span><br><span class="line">        tree[pos].lazy += w;</span><br><span class="line">        tree[pos].sum += <span class="number">1l</span>l * (r - l + <span class="number">1</span>) * w;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pushdown(pos, l, r);</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (ql &lt;= mid)</span><br><span class="line">        update(ql, qr, w, pos &lt;&lt; <span class="number">1</span>, l, mid);</span><br><span class="line">    <span class="keyword">if</span> (qr &gt; mid)</span><br><span class="line">        update(ql, qr, w, pos &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, r);</span><br><span class="line">    pushup(pos);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">ll <span class="title">query</span><span class="params">(<span class="keyword">int</span> ql, <span class="keyword">int</span> qr, <span class="keyword">int</span> pos, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ql &lt;= l &amp;&amp; r &lt;= qr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tree[pos].sum;</span><br><span class="line">    &#125;</span><br><span class="line">    pushdown(pos, l, r);</span><br><span class="line">    ll res = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (ql &lt;= mid)</span><br><span class="line">        res += query(ql, qr, pos &lt;&lt; <span class="number">1</span>, l, mid);</span><br><span class="line">    <span class="keyword">if</span> (qr &gt; mid)</span><br><span class="line">        res += query(ql, qr, pos &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, mid + <span class="number">1</span>, r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> L, <span class="keyword">int</span> R)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (L &gt; R)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (l == r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = L; i &lt;= R; i++)</span><br><span class="line">            <span class="keyword">if</span> (q[i].op == <span class="number">2</span>)</span><br><span class="line">                ans[q[i].id] = l;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> cntl = <span class="number">0</span>, cntr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = L; i &lt;= R; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (q[i].op == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (q[i].k &gt; mid)</span><br><span class="line">            &#123;</span><br><span class="line">                update(q[i].l, q[i].r, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, n);</span><br><span class="line">                qr[++cntr] = q[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ql[++cntl] = q[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ll sum = query(q[i].l, q[i].r, <span class="number">1</span>, <span class="number">1</span>, n);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (q[i].k &lt;= sum)</span><br><span class="line">                qr[++cntr] = q[i];</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                ql[++cntl] = q[i], ql[cntl].k -= sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= cntr; i++)</span><br><span class="line">        <span class="keyword">if</span> (qr[i].op == <span class="number">1</span>)</span><br><span class="line">            update(qr[i].l, qr[i].r, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">1</span>, n);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= cntl; i++)</span><br><span class="line">        q[L + i - <span class="number">1</span>] = ql[i];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= cntr; i++)</span><br><span class="line">        q[L + cntl + i - <span class="number">1</span>] = qr[i];</span><br><span class="line">    solve(l, mid, L, L + cntl - <span class="number">1</span>);</span><br><span class="line">    solve(mid + <span class="number">1</span>, r, L + cntl, R);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> m, Q;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d%d%d%lld"</span>, &amp;q[i].op, &amp;q[i].l, &amp;q[i].r, &amp;q[i].k);</span><br><span class="line">        <span class="keyword">if</span> (q[i].op == <span class="number">2</span>)</span><br><span class="line">            q[i].id = ++Q;</span><br><span class="line">    &#125;</span><br><span class="line">    solve(-n, n, <span class="number">1</span>, m);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= Q; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ans[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E6%A0%91%E5%A5%97%E6%A0%91/" rel="tag"># 树套树</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/17/%E6%95%B4%E4%BD%93%E4%BA%8C%E5%88%86/" rel="next" title="整体二分">
                <i class="fa fa-chevron-left"></i> 整体二分
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/20/APIO2016%E8%B5%9B%E8%89%87/" rel="prev" title="APIO2016划艇">
                APIO2016划艇 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/1.jpg"
                alt="HCN" />
            
              <p class="site-author-name" itemprop="name">HCN</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">67</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#权值线段树套区间线段树"><span class="nav-number">1.</span> <span class="nav-text">权值线段树套区间线段树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#树状数组套主席树"><span class="nav-number">2.</span> <span class="nav-text">树状数组套主席树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#整体二分"><span class="nav-number">3.</span> <span class="nav-text">整体二分</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#"><span class="nav-number"></span> <span class="nav-text">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
#include &lt;iostream&gt;
#include &lt;cstdio&gt;
#include &lt;algorithm&gt;
#include &lt;queue&gt;
#include &lt;cmath&gt;
#include &lt;cstring&gt;
#include &lt;vector&gt;
#include &lt;map&gt;
using namespace std;
typedef long long ll;
#define ls tr[pos].l
#define rs tr[pos].r
const int N &#x3D; 5e4 + 10;
const int mod &#x3D; 1e9 + 7;
struct xi
&amp;#123;
    int l, r;
&amp;#125; tree[N * 400];
ll sum[N * 400];
int tt[N][4], te[N], num, li[N], tcnt, ti[N][2];
int lowbit(int x)
&amp;#123;
    return (-x) &amp; x;
&amp;#125;
void add(int &amp;pos, int x, int w, int l &#x3D; 1, int r &#x3D; num)
&amp;#123;
    if (!pos)
        pos &#x3D; ++tcnt;
    sum[pos] +&#x3D; w;
    if (l &#x3D;&#x3D; r)
        return;
    int mid &#x3D; (l + r) &gt;&gt; 1;
    if (x &lt;&#x3D; mid)
        add(tree[pos].l, x, w, l, mid);
    else
    &amp;#123;
        add(tree[pos].r, x, w, mid + 1, r);
    &amp;#125;
&amp;#125;
int query(ll k, int x, int y, int l &#x3D; 1, int r &#x3D; num)
&amp;#123;
    if (l &#x3D;&#x3D; r)
        return l;
    ll R &#x3D; 0, L &#x3D; 0;
    &#x2F;&#x2F;cout &lt;&lt; te[0] &lt;&lt; &quot; &quot; &lt;&lt; te[1] &lt;&lt; &quot; &quot; &lt;&lt; te[2] &lt;&lt; &quot; &quot; &lt;&lt; te[3] &lt;&lt; endl;
    for (int i &#x3D; 1; i &lt;&#x3D; te[0]; i++)
        R -&#x3D; 1ll * (x + 1) * sum[tree[tt[i][0]].r]; &#x2F;&#x2F;ti[0]维护差分(x+1)*(d[1]+d[2]...d[x])
    for (int i &#x3D; 1; i &lt;&#x3D; te[1]; i++)
        R +&#x3D; 1ll * (y + 1) * sum[tree[tt[i][1]].r];
    for (int i &#x3D; 1; i &lt;&#x3D; te[2]; i++) &#x2F;&#x2F; ti[1维护(1*d[1]-2*d[2]...x*d[x])
        L -&#x3D; 1ll * sum[tree[tt[i][2]].r];
    for (int i &#x3D; 1; i &lt;&#x3D; te[3]; i++)
        L +&#x3D; 1ll * sum[tree[tt[i][3]].r];
    ll res &#x3D; R - L;
    &#x2F;&#x2F;cout &lt;&lt; x &lt;&lt; &quot; &quot; &lt;&lt; y &lt;&lt; &quot; &quot; &lt;&lt; res &lt;&lt; endl;
    int mid &#x3D; (l + r) &gt;&gt; 1;
    if (k &lt;&#x3D; res)
    &amp;#123;
        for (int i &#x3D; 1; i &lt;&#x3D; te[0]; i++)
            tt[i][0] &#x3D; tree[tt[i][0]].r;
        for (int i &#x3D; 1; i &lt;&#x3D; te[1]; i++)
            tt[i][1] &#x3D; tree[tt[i][1]].r;
        for (int i &#x3D; 1; i &lt;&#x3D; te[2]; i++) &#x2F;&#x2F; ti[1维护(1*d[1]-2*d[2]...x*d[x])
            tt[i][2] &#x3D; tree[tt[i][2]].r;
        for (int i &#x3D; 1; i &lt;&#x3D; te[3]; i++)
            tt[i][3] &#x3D; tree[tt[i][3]].r;
        return query(k, x, y, mid + 1, r);
    &amp;#125;

    else
    &amp;#123;
        for (int i &#x3D; 1; i &lt;&#x3D; te[0]; i++)
            tt[i][0] &#x3D; tree[tt[i][0]].l;
        for (int i &#x3D; 1; i &lt;&#x3D; te[1]; i++)
            tt[i][1] &#x3D; tree[tt[i][1]].l;
        for (int i &#x3D; 1; i &lt;&#x3D; te[2]; i++) &#x2F;&#x2F; ti[1维护(1*d[1]-2*d[2]...x*d[x])
            tt[i][2] &#x3D; tree[tt[i][2]].l;
        for (int i &#x3D; 1; i &lt;&#x3D; te[3]; i++)
            tt[i][3] &#x3D; tree[tt[i][3]].l;
        return query(k - res, x, y, l, mid);
    &amp;#125;
&amp;#125;
int pre_query(int l, int r, ll k)
&amp;#123;
    for (int i &#x3D; 0; i &lt; 4; i++)
        te[i] &#x3D; 0;

    l--;
    int x &#x3D; l, y &#x3D; r;
    while (l)
    &amp;#123;
        tt[++te[0]][0] &#x3D; ti[l][0];
        tt[++te[2]][2] &#x3D; ti[l][1];
        l -&#x3D; lowbit(l);
    &amp;#125;
    while (r)
    &amp;#123;
        tt[++te[1]][1] &#x3D; ti[r][0];
        tt[++te[3]][3] &#x3D; ti[r][1];
        r -&#x3D; lowbit(r);
    &amp;#125;

    return li[query(k, x, y)];
&amp;#125;
int n;
void update(int l, int r, int x)
&amp;#123;
    &#x2F;&#x2F;cout&lt;&lt;x&lt;&lt;endl;
    r++;
    int rr &#x3D; r;
    int ll &#x3D; l;
    while (r &lt;&#x3D; n)
    &amp;#123;
        add(ti[r][0], x, -1);
        add(ti[r][1], x, -rr);
        r +&#x3D; lowbit(r);
    &amp;#125;
    while (l &lt;&#x3D; n)
    &amp;#123;
        &#x2F;&#x2F;cout &lt;&lt; l &lt;&lt; endl;
        add(ti[l][0], x, 1);
        add(ti[l][1], x, ll);
        l +&#x3D; lowbit(l);
    &amp;#125;
    &#x2F;&#x2F;cout &lt;&lt; ti[2][0] &lt;&lt; endl;
&amp;#125;
struct node
&amp;#123;
    int op, l, r;
    ll k;
&amp;#125; q[N];
int m;
int main()
&amp;#123;
    scanf(&quot;%d%d&quot;, &amp;n, &amp;m);
    for (int i &#x3D; 1; i &lt;&#x3D; m; i++)
    &amp;#123;
        scanf(&quot;%d%d%d%lld&quot;, &amp;q[i].op, &amp;q[i].l, &amp;q[i].r, &amp;q[i].k);
        if (q[i].op &#x3D;&#x3D; 1)
            li[++num] &#x3D; q[i].k;
    &amp;#125;
    sort(1 + li, li + 1 + num);
    num &#x3D; unique(1 + li, li + 1 + num) - li - 1;
    for (int i &#x3D; 1; i &lt;&#x3D; m; i++)
        if (q[i].op &#x3D;&#x3D; 1)
            q[i].k &#x3D; lower_bound(1 + li, 1 + li + num, q[i].k) - li;

    for (int i &#x3D; 1; i &lt;&#x3D; m; i++)
    &amp;#123;
        if (q[i].op &#x3D;&#x3D; 1)
            update(q[i].l, q[i].r, q[i].k);
        else
        &amp;#123;
            printf(&quot;%d\n&quot;, pre_query(q[i].l, q[i].r, q[i].k));
        &amp;#125;
    &amp;#125;
&amp;#125;
</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#-1"><span class="nav-number"></span> <span class="nav-text">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
#include &lt;iostream&gt;
#include &lt;cstdio&gt;
#include &lt;algorithm&gt;
#include &lt;queue&gt;
#include &lt;cmath&gt;
#include &lt;cstring&gt;
#include &lt;vector&gt;
#include &lt;map&gt;
using namespace std;
typedef long long ll;
#define ls tr[pos].l
#define rs tr[pos].r
const int N &#x3D; 5e4 + 10;
const int mod &#x3D; 1e9 + 7;
struct segtree
&amp;#123;
    int l, r, lazy;
    ll sum;
&amp;#125; tr[N * 32 * 20];
int li[N], tcnt, num, n, ti[N &lt;&lt; 2];
void pushup(int pos)
&amp;#123;
    tr[pos].sum &#x3D; tr[ls].sum + tr[rs].sum;
&amp;#125;
void pushdown(int pos, int l, int r)
&amp;#123;
    int v &#x3D; tr[pos].lazy, mid &#x3D; (l + r) &gt;&gt; 1;

    if (v)
    &amp;#123;
        if (!tr[pos].l)
            tr[pos].l &#x3D; ++tcnt;
        if (!tr[pos].r)
            tr[pos].r &#x3D; ++tcnt;
        tr[ls].sum +&#x3D; v * (mid - l + 1);
        tr[rs].sum +&#x3D; v * (r - mid);
        tr[ls].lazy +&#x3D; v;
        tr[rs].lazy +&#x3D; v;
        tr[pos].lazy &#x3D; 0;
    &amp;#125;
&amp;#125;
int add(int pos, int ql, int qr, int l &#x3D; 1, int r &#x3D; n)
&amp;#123;
    if (!pos)
        pos &#x3D; ++tcnt;
    if (ql &lt;&#x3D; l &amp;&amp; r &lt;&#x3D; qr)
    &amp;#123;
        tr[pos].lazy++;
        tr[pos].sum +&#x3D; (r - l + 1);
        return pos;
    &amp;#125;
    pushdown(pos, l, r);
    int mid &#x3D; (l + r) &gt;&gt; 1;
    if (ql &lt;&#x3D; mid)
        tr[pos].l &#x3D; add(tr[pos].l, ql, qr, l, mid);
    if (qr &gt; mid)
        tr[pos].r &#x3D; add(tr[pos].r, ql, qr, mid + 1, r);
    &#x2F;&#x2F;tr[pos].sum &#x3D; tr[ls].sum + tr[rs].sum;
    pushup(pos);
    return pos;
&amp;#125;
ll calc(int pos, int ql, int qr, int l &#x3D; 1, int r &#x3D; n)
&amp;#123;
    if (!pos)
        return 0;
    if (ql &lt;&#x3D; l &amp;&amp; r &lt;&#x3D; qr)
    &amp;#123;
        return tr[pos].sum;
    &amp;#125;
    pushdown(pos, l, r);
    int mid &#x3D; (l + r) &gt;&gt; 1;
    ll res &#x3D; 0;
    if (ql &lt;&#x3D; mid)
        res +&#x3D; calc(tr[pos].l, ql, qr, l, mid);
    if (qr &gt; mid)
        res +&#x3D; calc(tr[pos].r, ql, qr, mid + 1, r);
    return res;
&amp;#125;
void update(int ql, int qr, int x, int pos &#x3D; 1, int l &#x3D; 1, int r &#x3D; num)
&amp;#123;
    ti[pos] &#x3D; add(ti[pos], ql, qr);
    if (l &#x3D;&#x3D; r)
        return;
    int mid &#x3D; (l + r) &gt;&gt; 1;
    if (x &lt;&#x3D; mid)
        update(ql, qr, x, pos &lt;&lt; 1, l, mid);
    else
        update(ql, qr, x, pos &lt;&lt; 1 | 1, mid + 1, r);
&amp;#125;

int query(int ql, int qr, ll k, int pos &#x3D; 1, int l &#x3D; 1, int r &#x3D; num)
&amp;#123;
    if (l &#x3D;&#x3D; r)
        return l;
    ll sum &#x3D; calc(ti[pos &lt;&lt; 1 | 1], ql, qr);
    &#x2F;&#x2F; cout &lt;&lt; pos &lt;&lt; &quot; &quot; &lt;&lt; ql &lt;&lt; &quot; &quot; &lt;&lt; qr &lt;&lt; &quot; &quot; &lt;&lt; sum &lt;&lt; &quot;---&quot; &lt;&lt; tr[2].lazy &lt;&lt; endl;
    int mid &#x3D; (l + r) &gt;&gt; 1;
    if (k &lt;&#x3D; sum)
        return query(ql, qr, k, pos &lt;&lt; 1 | 1, mid + 1, r);
    else
        return query(ql, qr, k - sum, pos &lt;&lt; 1, l, mid);
&amp;#125;
struct node
&amp;#123;
    int op, l, r;
    ll k;
&amp;#125; q[N];
int m;
int main()
&amp;#123;
    scanf(&quot;%d%d&quot;, &amp;n, &amp;m);
    for (int i &#x3D; 1; i &lt;&#x3D; m; i++)
    &amp;#123;
        scanf(&quot;%d%d%d%lld&quot;, &amp;q[i].op, &amp;q[i].l, &amp;q[i].r, &amp;q[i].k);
        if (q[i].op &#x3D;&#x3D; 1)
            li[++num] &#x3D; q[i].k;
    &amp;#125;
    sort(1 + li, li + 1 + num);
    num &#x3D; unique(1 + li, li + 1 + num) - li - 1;
    for (int i &#x3D; 1; i &lt;&#x3D; m; i++)
        if (q[i].op &#x3D;&#x3D; 1)
            q[i].k &#x3D; lower_bound(1 + li, 1 + li + num, q[i].k) - li;
    &#x2F;&#x2F;cout &lt;&lt; num &lt;&lt; endl;
    for (int i &#x3D; 1; i &lt;&#x3D; m; i++)
    &amp;#123;
        if (q[i].op &#x3D;&#x3D; 1)
            update(q[i].l, q[i].r, q[i].k);
        else
        &amp;#123;
            printf(&quot;%d\n&quot;, li[query(q[i].l, q[i].r, q[i].k)]); &#x2F;&#x2F;这里是第K大不是，第K小。
        &amp;#125;
    &amp;#125;
&amp;#125;
</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HCN</span>

  

</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
